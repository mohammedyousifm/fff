<?php
// int includes
include '../int/int.php';
// header includes
include $header . 'header.php';
include $data . 'contact-data.php';
session_start();
if (isset($_SESSION['admin_id'])) {

  header('location: dashboard.php');
  exit();
}

if (isset($_POST['submit'])) {
    $name = mysqli_real_escape_string($conn, $_POST['adminName']);
    $password = mysqli_real_escape_string($conn, $_POST['password']);

    $select = mysqli_query($conn, "SELECT * FROM  `admin` WHERE admin_name = '$name'") or die('query failed');
    if (mysqli_num_rows($select) > 0) {
        $row = mysqli_fetch_assoc($select);

        // Check if the entered password matches the stored hashed password
        if (hash('sha256', $password) == $row['admin_password']) {

            $currentDateTime = date('Y-m-d H:i:s');
            mysqli_query($conn, "UPDATE `admin` SET last_login = '$currentDateTime' WHERE admin_name = '" . $row['admin_name'] . "'");
              $_SESSION['admin_id'] = $row['admin_id'];
              $_SESSION['admin_name'] = $row['admin_name'];
            header('location:  dashboard.php');
            exit();
        } else {
            $errorMessage = 'Incorrect password!';
        }
    } else {
        $errorMessage = 'Incorrect username!';
    }
}
?>



<section id="login-dashboard">
    <div class="header-container text-center">
        <h1>Login to Dashboard</h1>
    </div>
    <div class="container">
        <div class="login-container">
            <div class="d-md-flex justify-content-md-center align-items-md-center text-center">
                <div class="img-container mb-md-0 mb-3">
                    <img src="../images/about-me-img.png" alt="Logo">
                </div>
                <div class="form-container">
                    <form id="form-login" method="post">
                        <div class="header-container text-center pt-md-0 pb-4">
                            <h2>Login to Dashboard</h2>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" name="adminName" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" name="password" placeholder="Password" >
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" name="submit" type="submit">Login</button>
                        </div>
                        <div id="message" class="mt-3">
                            <?php if (isset($errorMessage)) { ?>
                                <span class="span-message"></span> <?php echo $errorMessage; ?>
                            <?php } ?>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<?php

// footer includes
include $footer . 'footer.php';
?>